# ToolBelt

> An automated, version-managed deployment system for Linux CLI tools using Ansible

ToolBelt automatically tracks, updates, and deploys your favorite command-line tools across Linux systems. It fetches the latest versions from GitHub, verifies checksums, and uses Ansible to ensure consistent tool installations across all your machines.

## Features

- ğŸ”„ **Automatic Version Tracking**: Queries GitHub API for latest releases
- ğŸ” **Checksum Verification**: Automatically calculates and verifies SHA256 checksums
- ğŸ“¦ **Multiple Install Methods**: Supports `.deb` packages and compressed archives
- ğŸ¯ **Declarative Configuration**: Simple YAML-based tool definitions
- ğŸš€ **Idempotent Deployment**: Ansible ensures tools are only updated when needed
- ğŸŒ **Multi-Host Support**: Deploy to one or many systems simultaneously

## Prerequisites

- **Python 3.14+**
- **uv** - Fast Python package installer ([astral-sh/uv](https://github.com/astral-sh/uv))
- **Ansible** - Installed via `uv` and globally accessible

### Installing Prerequisites

1. Install `uv` (follow instructions at [astral-sh/uv](https://github.com/astral-sh/uv))

2. Install Ansible with all required executables:
   ```bash
   uv tool install --with-executables-from ansible-core,ansible-lint ansible
   ```
   
   This installs:
   - **From `ansible-core`**: `ansible`, `ansible-config`, `ansible-console`, `ansible-doc`, `ansible-galaxy`, `ansible-inventory`, `ansible-playbook`, `ansible-pull`, `ansible-test`, `ansible-vault`
   - **From `ansible-lint`**: `ansible-lint`
   - **Main executable**: `ansible-community`

## Configuration

### Tool Definitions (`tools_versions.yml`)

Define your tools in `tools_versions.yml`:

```yaml
tools:
  bat:
    version: 0.26.1
    github_repo: sharkdp/bat
    url_template: https://github.com/sharkdp/bat/releases/download/v{version}/bat_{version}_amd64.deb
    install_type: deb
    checksum: sha256:ad59954aa1540e526f97267f60557ea5ef4c7dcf91a0811254134537cb353a3c
  
  restic:
    version: 0.18.1
    github_repo: restic/restic
    url_template: https://github.com/restic/restic/releases/download/v{version}/restic_{version}_linux_amd64.bz2
    install_type: bz2
    binary_name: restic
```

#### Field Descriptions

| Field | Required | Description |
|-------|----------|-------------|
| `version` | Yes | Current version number (without 'v' prefix) |
| `github_repo` | Yes | GitHub repository in `owner/repo` format |
| `url_template` | Yes | Download URL with `{version}` placeholder |
| `install_type` | Yes | Installation method: `deb`, `tar`, or `bz2` |
| `checksum` | No* | SHA256 checksum in format `sha256:<hash>` |
| `binary_name` | For `tar`/`bz2` | Name of the binary to extract/install |

*Checksum is auto-generated by `update_versions.py` if missing

### Environment Variables (`.env`)

Create a `.env` file for optional configuration:

```bash
# Optional: Increases GitHub API rate limit from 60 to 5000 requests/hour
GITHUB_TOKEN=ghp_your_token_here
```

## Usage

### Basic Workflow

ToolBelt uses a two-step process:

#### Step 1: Update Version Information

```bash
python update_versions.py
```

This script:
- Queries GitHub API for the latest release of each tool
- Downloads the release file to calculate SHA256 checksum
- Updates `tools_versions.yml` with new versions and checksums
- Only updates when versions change or checksums are missing

**Example Output:**
```
INFO: Checking bat (Current: 0.26.0)...
ğŸš€ UPDATE FOUND for bat: 0.26.0 -> 0.26.1
   Downloading to calculate hash: https://github.com/sharkdp/bat/releases/download/v0.26.1/bat_0.26.1_amd64.deb
INFO: Checking restic (Current: 0.18.1)...
   restic is up to date.
âœ… tools_versions.yml updated with versions and checksums.
```

#### Step 2: Deploy Tools

```bash
ansible-playbook deploy_tools.yml
```

This playbook:
- Downloads tools from URLs in `tools_versions.yml`
- Verifies checksums before installation
- Installs `.deb` packages via `apt`
- Extracts and installs binaries from archives to `/usr/local/bin`
- Runs idempotently (only updates when needed)

**Default Behavior:** Runs on `localhost` with privilege escalation

### Advanced Usage

#### Deploy to Remote Hosts

Create an inventory file `hosts.ini`:

```ini
[servers]
server1.example.com
server2.example.com

[workstations]
laptop.local
```

Run against specific hosts:

```bash
# Deploy to all servers
ansible-playbook -i hosts.ini deploy_tools.yml --limit servers

# Deploy to specific host
ansible-playbook -i hosts.ini deploy_tools.yml --limit server1.example.com
```

#### Check Mode (Dry Run)

Preview changes without making them:

```bash
ansible-playbook deploy_tools.yml --check --diff
```

#### Install Specific Tools Only

Modify the playbook or use tags (requires adding tags to tasks):

```bash
# Example if you add tags to tasks
ansible-playbook deploy_tools.yml --tags "bat"
```

## Adding New Tools

### For Debian Packages (.deb)

1. Add to `tools_versions.yml`:
   ```yaml
   tools:
     neovim:
       version: 0.9.5
       github_repo: neovim/neovim
       url_template: https://github.com/neovim/neovim/releases/download/v{version}/nvim-linux64.deb
       install_type: deb
   ```

2. Run `python update_versions.py` to fetch latest version and checksum

3. Deploy with `ansible-playbook deploy_tools.yml`

### For Compressed Archives (.tar, .bz2, .gz)

1. Add to `tools_versions.yml`:
   ```yaml
   tools:
     ripgrep:
       version: 14.1.0
       github_repo: BurntSushi/ripgrep
       url_template: https://github.com/BurntSushi/ripgrep/releases/download/{version}/ripgrep-{version}-x86_64-unknown-linux-musl.tar.gz
       install_type: tar
       binary_name: rg
   ```

2. Run `python update_versions.py`

3. Deploy with `ansible-playbook deploy_tools.yml`

> **Note**: The `binary_name` field tells Ansible which file to extract from the archive

## How It Works

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tools_versions.yml  â”‚ â† Tool definitions
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â†’ update_versions.py
           â”‚   â”œâ”€ Queries GitHub API
           â”‚   â”œâ”€ Downloads releases
           â”‚   â”œâ”€ Calculates checksums
           â”‚   â””â”€ Updates YAML file
           â”‚
           â””â”€â†’ deploy_tools.yml
               â”œâ”€ Reads tool definitions
               â”œâ”€ Downloads with checksum verification
               â””â”€ Installs via apt or direct extraction
```

### Version Update Process

1. **GitHub API Query**: Fetches latest release tag
2. **Version Comparison**: Compares with current version in YAML
3. **Download**: Retrieves release file if update found
4. **Hash Calculation**: Computes SHA256 checksum
5. **YAML Update**: Writes new version and checksum

### Deployment Process

**For `.deb` packages:**
1. Download to `/tmp/<tool>.deb` with checksum verification
2. Install via `apt` module
3. Clean up temporary files

**For tar archives:**
1. Download to `/tmp/<tool>.archive` with checksum verification
2. Extract specified binary to `/usr/local/bin`
3. Set executable permissions (`0755`)
4. Clean up temporary files

**For compressed binaries (.bz2):**
1. Download to `/tmp/<tool>.bz2` with checksum verification
2. Decompress directly to `/usr/local/bin/<binary_name>`
3. Set executable permissions (`0755`)
4. Clean up temporary files

## Troubleshooting

### GitHub API Rate Limiting

**Problem:** `Failed to fetch version for <repo>: 403 Client Error`

**Solution:** Set `GITHUB_TOKEN` in `.env` file to increase rate limit from 60 to 5000 requests/hour

### Checksum Verification Failed

**Problem:** `Checksum mismatch for <tool>`

**Solution:** 
1. Delete the checksum line from `tools_versions.yml`
2. Run `python update_versions.py` to recalculate
3. Try deployment again

### Permission Denied During Installation

**Problem:** `Permission denied` when running playbook

**Solution:** Ensure you're running with `become: true` (already configured) and your user has sudo privileges

### Binary Not Found After Installation

**Problem:** Installed tool not in PATH

**Solution:** 
- For archives, verify `/usr/local/bin` is in your `$PATH`
- Check that `binary_name` matches the actual binary in the archive
- Verify permissions: `ls -l /usr/local/bin/<binary>`

### Tool Not Updating

**Problem:** `update_versions.py` reports "up to date" but you know there's a new version

**Solution:**
1. Check if the GitHub release uses a different tag format (e.g., `v0.1.0` vs `0.1.0`)
2. Verify `github_repo` is correct
3. Check GitHub API response manually: `curl https://api.github.com/repos/<owner>/<repo>/releases/latest`

## Project Structure

```
toolbelt/
â”œâ”€â”€ .env                    # Environment variables (optional)
â”œâ”€â”€ tools_versions.yml      # Tool definitions and versions
â”œâ”€â”€ update_versions.py      # Version checker and updater
â”œâ”€â”€ deploy_tools.yml        # Ansible playbook for deployment
â”œâ”€â”€ README.md              # This file
â””â”€â”€ LICENSE                # GPL-3.0 license
```

## Contributing

### Adding Support for New Install Types

Currently supported: `deb`, `tar`, `bz2`

To add support for other package formats (e.g., `rpm`, `snap`):

1. Add a new task block in `deploy_tools.yml`
2. Follow the existing pattern (download â†’ install)
3. Use appropriate Ansible module (`yum`, `snap`, etc.)

### Submitting Tool Definitions

Feel free to submit PRs with new tool definitions! Ensure:
- The tool has a GitHub releases page
- The URL template is correct
- You've tested the installation locally

## License

This project is licensed under the GNU General Public License v3.0 - see the [LICENSE](LICENSE) file for details.

## Acknowledgments

Built with:
- [Ansible](https://github.com/ansible/ansible) - Automation engine
- [uv](https://github.com/astral-sh/uv) - Fast Python package installer
- [PyYAML](https://pyyaml.org/) - YAML parser
- [Requests](https://requests.readthedocs.io/) - HTTP library

---

**Current Tools Managed:**
- [bat](https://github.com/sharkdp/bat) - A cat clone with syntax highlighting
- [restic](https://github.com/restic/restic) - Fast, secure backup program
